yum install -y epel-release
yum install -y python-pip
pip install -U pip
yum install -y python-devel libffi-devel gcc openssl-devel libselinux-python

yum install -y ansible

pip install -U ansible

yum install -y git docker

systemctl stop NetworkManager
systemctl disable NetworkManager
systemctl restart network
systemctl enable network

############# multinode用
cat << EOT3 >> /etc/hosts 2>&1
133.130.116.168 controller
150.95.147.142 conpute
EOT3
############# multinode用




vi /etc/ansible/ansible.cfg
####[defaults]の直下に入れる
host_key_checking=False
pipelining=True
forks=100
validate_certs=False
####


pip install kolla-ansible -I -U
git clone https://github.com/openstack/kolla-ansible -b stable/queens
cd kolla-ansible
pip install -r requirements.txt
python setup.py install
cd 
cp -r kolla-ansible/etc/kolla /etc/kolla/
cp kolla-ansible/ansible/inventory/* .


############queensはインストールできるが、rockyはダメ
############（kolla-ansible -i multinode deployでエラーになる）修正されるの期待
vi /etc/kolla/globals.yml
############
 kolla_base_distro: "centos"
 kolla_install_type: "source"
 openstack_release: "queens"

 #ダッシュボードアクセス用IP(IPは適宜変更すること)
 kolla_internal_vip_address: "150.95.200.86"
 network_interface: "eth0"
 neutron_external_interface: "eth1"
 enable_haproxy: "no"
 nova_compute_virt_type: "qemu"
############

kolla-genpwd

vi /etc/kolla/passwords.yml
####Horizonのログインパスワード（変更推奨）
 keystone_admin_password: Sunny@5315
####




vi multinode
############# multinode用
適当に変える
############# multinode用






kolla-ansible -i all-in-one bootstrap-servers
→Dockerのエラーが出た場合Docker関連パッケージを全部消すこと
#####
rpm -qa | grep docker
yum erase ......
#####


kolla-ansible -i all-in-one prechecks
kolla-ansible -i all-in-one deploy



############# multinode用
kolla-ansible -i multinode bootstrap-servers
kolla-ansible -i multinode prechecks
kolla-ansible -i multinode deploy
############# multinode用


kolla-ansible post-deploy

pip install python-openstackclient python-glanceclient python-neutronclient -I -U

. /etc/kolla/admin-openrc.sh
. /usr/share/kolla-ansible/init-runonce
（途中で聞かれるパスフレーズは何も入力せずエンターキー押下しても問題ないです）

openstack server create \
    --image cirros \
    --flavor m1.tiny \
    --key-name mykey \
    --nic net-id=7ef37cde-26aa-4939-ae3f-9cb42666f4b5 \
    demo1



構築直後はPublicネットワーク(10.0.2.0/24)へのアクセス用のブリッジが未設定のため、ホストOS上で以下を設定します。
これにより、Publicネットワーク上のフローティングIPアドレスに対して、ホストからpingやsshが可能になります。

ip addr add 10.0.2.1/24 dev br-ex
ip link set br-ex up
ip route add 10.0.2.0/24 dev br-ex

また、OpenStack上のインスタンスからインターネットにアクセスできるようにするために、ホストOS側にソースNATの設定を追加します。
（Publicネットワークから送られてきたパケットはソースNATしてeth0のインタフェースから送信する設定）

iptables -t nat -A POSTROUTING -o eth0 -s 10.0.2.0/24 -j MASQUERADE


http://133.130.117.183



