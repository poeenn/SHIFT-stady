# NW設定
hostnameの設定
```
nmcli general hostname bear1
nmcli general hostname bear2
nmcli general hostname bear3
nmcli general hostname bear4
nmcli general hostname bear5
```

hostsを全ノードに設定
```
cat << EOF >> /etc/hosts 2>&1
192.168.20.254 L2SW
192.168.20.1 bear1 
192.168.20.2 bear2 
192.168.20.3 bear3 
192.168.20.4 bear4 
192.168.20.5 bear5 
10.0.10.101 k8s-master1 
10.0.10.102 k8s-node1 
10.0.10.103 k8s-node2 
EOF
```

ifconfigの設定
```
nmcli dev
nmcli con

nmcli con mod "Wired connection 1" connection.id eth1
nmcli con mod "eth1" connection.interface-name eth1

nmcli c down eth1



#bear1用
nmcli c modify eth1 ipv4.addresses "192.168.20.1"/24 

#bear2用
nmcli c modify eth1 ipv4.addresses "192.168.20.2"/24 

#bear3用
nmcli c modify eth1 ipv4.addresses "192.168.20.3"/24 

#bear4用
nmcli c modify eth1 ipv4.addresses "192.168.20.4"/24 

#bear5用
nmcli c modify eth1 ipv4.addresses "192.168.20.5"/24 


nmcli con mod eth1 connection.autoconnect "yes"
nmcli con mod eth1 ipv4.method manual 

nmcli c up eth1
```

ルーティング設定の確認
```
route
```

設定されていなければrouteの設定（多分必要ない）
```
route add xxx
```


# ユーザ作成＋sudo
gitのユーザアカウント名でユーザ作成（ansibleユーザも作る）  
オプションでパスワードも設定してしまう。パスワードは全部同じ（設定値は別のテキスト参照）
```
useradd xxx -p password
```

次回ログイン時にパスワード変更させる設定
```
passwd -e xxx
```
 
visudoで/etc/sudoersを開き、下記の行のコメントアウトを外す。
```
 visudo
## Allows people in group wheel to run all commands
%wheel  ALL=(ALL)       ALL
```

sudoさせるユーザをwheelグループに追加
```
 usermod -aG wheel xxx
```

入れるか要検討
> wheelグループのユーザーはすべてsu -でrootになれるようにする  
> /etc/pam.d/su  
> -#auth            required        pam_wheel.so use_uid  
> +auth            required        pam_wheel.so use_uid  
> ユーザ作成  
>   



# pyenvとか
パッケージのインストール
```
yum install -y gcc zlib-devel bzip2 bzip2-devel readline readline-devel sqlite sqlite-devel git openssl-devel libffi-devel epel-release python-pip python-devel
pip install pip --upgrade

```

pyenvリポジトリのクローン
```
git clone https://github.com/pyenv/pyenv.git ~/.pyenv

```

bashrcにpyenvのパスを追加  
bash_profile でもどっちでもいいが、SSHで接続したときに環境変数しか読まれないらしい
```
echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(pyenv init -)"' >> ~/.bashrc
source ~/.bashrc

```

バージョン確認
```
pyenv --version
python --version

```

pyenvを入れる
```
cd .pyenv/plugins
git clone git://github.com/yyuu/pyenv-virtualenv.git

```

2.Xのバージョンで最新バージョンを確認する
```
pyenv install --list

```

確認したバージョンをインストールする  
デフォルトで2.7.5が入っているっぽい（minimalだと違うかも）  
もともと入っているバージョンだと入らない？のかエラーが出る  
ので現状の最新版っぽい2.7.15に入れる
```
pyenv install 2.7.15

```

pipでパッケージのインストール
```
cat << EOF >> requirements.txt 2>&1
ansible
Jinja2
MarkupSafe
PyYAML
ecdsa
httplib2
paramiko
pycrypto
EOF

pip install -r requirements.txt

```

ansible コマンドを有効化
```
pyenv virtualenv --distribute 2.7.15 ansible
pyenv rehash

```
ansibleユーザにも入れておく
```
su - ansible
git clone https://github.com/pyenv/pyenv.git ~/.pyenv

echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> /home/ansible/.bashrc
echo 'eval "$(pyenv init -)"' >> /home/ansible/.bashrc

cd .pyenv/plugins
git clone git://github.com/yyuu/pyenv-virtualenv.git

exit

```

# SSH設定
sudoでパスワード聞かれないようにする
```
visudo
ansible ALL=(ALL) NOPASSWD:ALL  

```

ansibleユーザで鍵を作成する（bear1のみ）
```
su - ansible
ssh-keygen -t rsa -b 4096
chmod 700 /home/ansible/.ssh  
cat /home/ansible/.ssh/id_rsa.pub >> /home/ansible/.ssh/authorized_keys
chmod 600 /home/ansible/.ssh/authorized_keys  
exit

```

鍵を各サーバへコピーする
```
ssh-copy-id -i /home/ansible/.ssh/id_rsa.pub ansible@bear2
ssh-copy-id -i /home/ansible/.ssh/id_rsa.pub ansible@bear3
ssh-copy-id -i /home/ansible/.ssh/id_rsa.pub ansible@bear4
ssh-copy-id -i /home/ansible/.ssh/id_rsa.pub ansible@bear5
```

sshd_configの設定変更
```
vi /etc/ssh/sshd_config

# rootログイン禁止
PermitRootLogin no

# パスワードログイン禁止(要検討)外からアクセスするのであれば鍵認証したほうがいいと思う
# PasswordAuthentication no

```

誰でもログインできる共有ユーザを作る気はない（個人ユーザの意味がなくなってしまう）のでansibleユーザにログイン制限をかける
```
cat << EOF >> /etc/ssh/sshd_config 2>&1
Match User ansible
 PasswordAuthentication no
 AuthorizedKeysFile .ssh/authorized_keys
EOF
```

sshサーバをリスタート
```
/etc/rc.d/init.d/sshd restart
```

> ~/.ssh/configに書いとくかは要検討  
> ansible.cfgで設定するのであればユーザ毎のプロファイルではなく、別のファイルを指定することが可能  
> （だが、ansible以外でSSHログインする必要があるのであれば設定する必要がある）
> ```
> vi ~/.ssh/config
> 
> Host xxxIPとか
> User xxx
> HostName xxx
> IdentityFile ~/.ssh/id_rsa
> ```

# ssh接続確認
bear1から他のサーバへログインする
```
su - ansible
ssh ansible@bear2
exit
ssh ansible@bear3
exit
ssh ansible@bear4
exit
ssh ansible@bear5
exit
```

